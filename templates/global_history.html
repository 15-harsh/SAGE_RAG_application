<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Global History</title>
        <link rel="icon" href="static\images\logo.png" type="image/png">
        <link rel="stylesheet" href="static\excell.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Zalando+Sans+Expanded:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
        <script src="https://kit.fontawesome.com/d8ee8fbd1a.js" crossorigin="anonymous"></script>
    </head>

    <body>

        <nav>
            <ul>
                <li>
                    <div class="chat-header">Global History</div>
                </li>
                <li>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </li>
            </ul>
        </nav>


        <button id="toggleSidebar" class="toggle-btn">☰ SAGE</button>

        <div class="sidebar hide" id="sidebar"> 

            <a href="{{ url_for('dashboard')}}">Dashboard</a>
            <a href="{{ url_for('chat_directly')}}">Chat directly</a>
            <a href="{{ url_for('upload_excell')}}">Upload Excel</a>
            <a href="{{ url_for('list_pdfs')}}">Knowledge Base</a>

        </div>


        <div class="chat-container">

            {% if global_history %}
            <div class="results-container">

                    <div class="results-header">

                        <div class="results-title">
                            <i class="fas fa-table"></i> Global History
                        </div>

                    </div>

                <div class="summary-info">
                    <strong>Total Unique Questions:</strong> {{ global_history|length }}
                </div>

                <table class="results-table">

                    <thead>
                        <tr>
                            <th></th>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Sources</th>
                            <th>C.I</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody>

                        {% for result in global_history %}
                        <tr>
                            <td class="index-cell">{{ loop.index }}</td>

                            <td class="question-cell">{{ result.question }}</td>

                            <td class="answer-cell" id="answer-{{ result.question_id }}">
                                {{ result.edited_answer if result.edited_answer else result.answer }}
                            </td>

                            <td class="sources-cell">
                                {% for src in result.sources.split('[') if src.strip() %}
                                    {{ src.strip() }}<br><br>
                                {% endfor %}
                            </td>

                            <td class="confidence-cell">

                                {% if result.confidence >= 70 %}
                                    <span class="confidence-badge confidence-high">
                                        {{ result.confidence}}%
                                    </span>

                                {% elif result.confidence >= 40 %}
                                    <span class="confidence-badge confidence-medium">
                                        {{ result.confidence }}%
                                    </span>

                                {% else %}
                                    <span class="confidence-badge confidence-low">
                                        {{ result.confidence }}%
                                    </span>
                                {% endif %}

                            </td>

                            <td class="action-cell">

                                {% if result.accepted == None %}
                                    <button
                                        onclick="acceptExcel('{{ result.question_id }}')"
                                        class="action-btn accept-btn">
                                        ✔ Approve
                                    </button>
                                
                                {% else %}
                                    <span class="accepted-label">✔ Approved</span>
                                {% endif %}

                                <button
                                    type="button"
                                    onclick="editExcel('{{ result.question_id }}')"
                                    class="action-btn edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>


        <script>
            const toggleBtn = document.getElementById("toggleSidebar");
            const sidebar = document.getElementById("sidebar");

            toggleBtn.addEventListener("click", function () {
                sidebar.classList.toggle("hide");
            });
        </script>

        <script>

            function acceptExcel(questionId){

                fetch("/excel/accept", {

                    method: "POST",

                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },

                    body: "question_id=" + questionId
                })
                .then(res => res.json())
                .then(data => {

                    if(data.status === "success"){

                        location.reload(); // refresh to show Accepted
                    }
                });
            }

            function editExcel(id){

                const box = document.getElementById("answer-" + id);

                if(!box || box.querySelector("textarea")) return;

                const old = box.innerText.trim();

                // Store old text safely
                box.dataset.old = old;

                box.innerHTML = `
                    <textarea>${old}</textarea><br>

                    <button class="save-btn" onclick="saveEdit('${id}')">
                        Save
                    </button>

                    <button class="cancel-btn" onclick="cancelEdit('${id}')">
                        Cancel
                    </button>
                `;
            }

            function saveEdit(id){

                const box = document.getElementById("answer-" + id);

                const text = box.querySelector("textarea").value.trim();

                if(!text) return alert("Answer cannot be empty!");

                fetch("/excel/edit", {
                    method: "POST",
                    headers: {"Content-Type":"application/x-www-form-urlencoded"},
                    body: "question_id="+id+"&new_answer="+encodeURIComponent(text)
                })
                .then(r => r.json())
                .then(d => {

                    if(d.status === "success"){
                        box.innerText = text;
                    }
                    else{
                        alert("Failed to save!");
                    }

                });
            }

            function cancelEdit(id){

                const box = document.getElementById("answer-" + id);

                box.innerText = box.dataset.old;
            }

        </script>

    </body>

</html>